<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>3D Grid Sculptor</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/exporters/GLTFExporter.js"></script>
  <style>
    body { margin: 0; padding: 0; overflow: hidden; background-color: #000; font-size: 10px; }
    .slider-container {
      max-height: 95vh;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: rgba(255,255,255,0.2) transparent;
      position: absolute;
      top: 10px; left: 10px;
      background: rgba(0, 0, 0, 0.7); padding: 10px; border-radius: 5px;
      font-family: Arial, sans-serif; z-index: 100; color: white; width: 240px;
    }
    .slider { 
      width: 100px; 
      margin: 5px 0; 
      height: 4px;
      -webkit-appearance: none;
      background: #555;
      border-radius: 2px;
      outline: none;
    }
    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 10px;
      height: 10px;
      background: #fff;
      cursor: pointer;
      border-radius: 0;
    }
    .slider-value {
      display: inline-block;
      width: 40px;
      text-align: right;
      margin-left: 8px;
      font-size: 10px;
    }
    .random-value {
      color: yellow;
    }
    button {
      background: #444; 
      color: white; 
      border: none;
      padding: 5px 8px; 
      margin: 3px; 
      border-radius: 3px; 
      cursor: pointer; 
      font-size: 10px;
      transition: background 0.2s;
    }
    button:hover {
      background: #555;
    }
    button.active { 
      background: #777; 
      font-weight: bold;
    }
    .control-group { 
      margin: 10px 0; 
      padding: 8px 0; 
      border-top: 1px solid #333; 
    }
    .control-item {
      margin: 8px 0;
      display: flex;
      align-items: center;
    }
    label { 
      display: inline-block; 
      width: 110px; 
      margin-right: 5px;
      font-size: 10px;
    }
    .god-mode-panel {
      display: none; 
      margin-top: 10px; 
      padding-top: 10px; 
      border-top: 1px solid #555;
    }
    .god-mode-input { 
      margin: 10px 0;
      display: flex;
      align-items: center;
    }
    .god-mode-input label {
      width: auto;
      margin-right: 5px;
    }
    input[type="password"] { 
      width: 60px; 
      padding: 3px; 
      font-size: 10px;
      background: #333;
      border: 1px solid #555;
      color: white;
      border-radius: 3px;
    }
    .color-palette {
      display: flex; 
      flex-wrap: wrap; 
      margin-top: 5px;
    }
    .color-option {
      width: 20px; 
      height: 20px; 
      margin: 2px;
      cursor: pointer; 
      border: 1px solid #fff;
      transition: transform 0.2s;
    }
    .color-option:hover {
      transform: scale(1.1);
    }
    .bg-color-option {
      width: 30px; 
      height: 20px; 
      margin: 2px;
      cursor: pointer; 
      border: 1px solid #fff;
    }
    .view-buttons {
      display: flex;
      gap: 5px;
      margin-top: 5px;
    }
    .panel-title {
      font-size: 12px;
      font-weight: bold;
      margin-bottom: 10px;
      padding-bottom: 5px;
      border-bottom: 1px solid #888;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .axis-indicator {
      position: absolute;
      bottom: 20px;
      right: 20px;
      width: 100px;
      height: 100px;
      z-index: 100;
      pointer-events: none;
    }
    .slider-container::-webkit-scrollbar {
      width: 6px;
    }
    .slider-container::-webkit-scrollbar-thumb {
      background-color: rgba(255,255,255,0.2);
      border-radius: 3px;
    }
    .slider-container::-webkit-scrollbar-track {
      background: transparent;
    }
  </style>
</head>
<body>
  <div class="slider-container">
    <div class="panel-title">Panel de parámetros</div>

    <div class="control-item">
      <label for="subdivisionSlider">Subdivisión</label>
      <input type="range" min="1" max="10" value="5" class="slider" id="subdivisionSlider">
      <span class="slider-value" id="subdivisionValue">5</span>
    </div>
    <div class="control-item">
      <label for="maxExtrusionSlider">Extrusión Máx</label>
      <input type="range" min="0" max="300" value="100" class="slider" id="maxExtrusionSlider">
      <span class="slider-value" id="maxExtrusionValue">100</span>
    </div>
    <div class="control-item">
      <label for="minExtrusionSlider">Extrusión Mín</label>
      <input type="range" min="0" max="300" value="0" class="slider" id="minExtrusionSlider">
      <span class="slider-value" id="minExtrusionValue">0</span>
    </div>
    <div class="control-item">
      <label for="randomnessSlider">Aleatoriedad Ext</label>
      <input type="range" min="0" max="100" value="50" class="slider" id="randomnessSlider">
      <span class="slider-value random-value" id="randomnessValue">50</span>
    </div>
    <div class="control-item">
      <label for="boxSizeSlider">Tamaño</label>
      <input type="range" min="10" max="100" value="90" class="slider" id="boxSizeSlider">
      <span class="slider-value" id="boxSizeValue">90%</span>
    </div>

    <div class="god-mode-input">
      <label>Premium code:</label>
      <input type="password" id="godModeCode" placeholder="Code">
      <button id="godModeBtn">Activate</button>
    </div>

    <div class="god-mode-panel" id="godModePanel">
      <div class="control-item">
        <label for="maxVerticalSlider">Desplaz. Máx</label>
        <input type="range" min="0" max="300" value="0" class="slider" id="maxVerticalSlider">
        <span class="slider-value" id="maxVerticalValue">0</span>
      </div>
      <div class="control-item">
        <label for="minVerticalSlider">Desplaz. Mín</label>
        <input type="range" min="0" max="300" value="0" class="slider" id="minVerticalSlider">
        <span class="slider-value" id="minVerticalValue">0</span>
      </div>
      <div class="control-item">
        <label for="verticalRandomSlider">Aleatoriedad Desp</label>
        <input type="range" min="0" max="100" value="50" class="slider" id="verticalRandomSlider">
        <span class="slider-value random-value" id="verticalRandomValue">50</span>
      </div>
      
      <div class="control-group">
        <div class="panel-title">Configuración de Losa</div>
        <div class="control-item">
          <label for="increaseSlabSizeSlider">Aumentar tamaño</label>
          <input type="range" min="100" max="300" value="100" class="slider" id="increaseSlabSizeSlider">
          <span class="slider-value" id="increaseSlabSizeValue">100%</span>
        </div>
        <div class="control-item">
          <label for="decreaseSlabSizeSlider">Disminuir tamaño</label>
          <input type="range" min="0" max="100" value="100" class="slider" id="decreaseSlabSizeSlider">
          <span class="slider-value" id="decreaseSlabSizeValue">100%</span>
        </div>
        <div class="control-item">
          <label for="slabSizeRandomSlider">Aleatoriedad Tamaño</label>
          <input type="range" min="0" max="100" value="0" class="slider" id="slabSizeRandomSlider">
          <span class="slider-value random-value" id="slabSizeRandomValue">0</span>
        </div>
        <div class="control-item">
          <label for="increaseSlabThicknessSlider">Aumentar espesor</label>
          <input type="range" min="5" max="25" value="5" class="slider" id="increaseSlabThicknessSlider">
          <span class="slider-value" id="increaseSlabThicknessValue">5</span>
        </div>
        <div class="control-item">
          <label for="decreaseSlabThicknessSlider">Disminuir espesor</label>
          <input type="range" min="0" max="5" value="5" class="slider" id="decreaseSlabThicknessSlider">
          <span class="slider-value" id="decreaseSlabThicknessValue">5</span>
        </div>
        <div class="control-item">
          <label for="slabThicknessRandomSlider">Aleatoriedad Espesor</label>
          <input type="range" min="0" max="100" value="0" class="slider" id="slabThicknessRandomSlider">
          <span class="slider-value random-value" id="slabThicknessRandomValue">0</span>
        </div>
        <div class="control-item">
          <label>Color Losa</label>
          <div class="color-palette">
            <div class="color-option" style="background-color: #228B22" data-slabcolor="#228B22"></div>
            <div class="color-option" style="background-color: #006400" data-slabcolor="#006400"></div>
            <div class="color-option" style="background-color: #00FF7F" data-slabcolor="#00FF7F"></div>
            <div class="color-option" style="background-color: #32CD32" data-slabcolor="#32CD32"></div>
            <div class="color-option" style="background-color: #3CB371" data-slabcolor="#3CB371"></div>
          </div>
        </div>
        <button id="toggleSlabBtn" class="active">Mostrar Losa</button>
      </div>
      
      <div class="control-group">
        <div class="view-buttons">
          <button id="godWireframeBtn">Wireframe</button>
          <button id="godSolidBtn" class="active">Sólido</button>
          <button id="godPixelBtn">Pixel</button>
        </div>
        <div class="view-buttons">
          <button id="view1Btn">Axonométrica</button>
          <button id="view2Btn">Isométrica</button>
        </div>
      </div>
      <div class="control-group">
        <div class="control-item">
          <button id="godAutoRotateBtn">Autorotate</button>
          <label for="godRotateSpeedSlider" style="width:60px;">Velocidad</label>
          <input type="range" min="1" max="10" value="3" class="slider" id="godRotateSpeedSlider">
          <span class="slider-value" id="rotateSpeedValue">3</span>
        </div>
      </div>
      <div class="control-item">
        <label>Color</label>
        <div class="color-palette">
          <div class="color-option" style="background-color: #000000" data-color="#000000"></div>
          <div class="color-option" style="background-color: #ffffff" data-color="#ffffff"></div>
          <div class="color-option" style="background-color: #ff0000" data-color="#ff0000"></div>
          <div class="color-option" style="background-color: #00ff00" data-color="#00ff00"></div>
          <div class="color-option" style="background-color: #0000ff" data-color="#0000ff"></div>
          <div class="color-option" style="background-color: #ffff00" data-color="#ffff00"></div>
          <div class="color-option" style="background-color: #ff00ff" data-color="#ff00ff"></div>
          <div class="color-option" style="background-color: #00ffff" data-color="#00ffff"></div>
          <div class="color-option" style="background-color: #ff8800" data-color="#ff8800"></div>
          <div class="color-option" style="background-color: #4B3621" data-color="#4B3621"></div>
          <div class="color-option" style="background: linear-gradient(45deg, #ffffff, #cccccc, #999999, #666666)" data-color="metal" id="metalColor"></div>
          <div class="color-option" id="rainbowColor" style="background: linear-gradient(45deg, red, orange, yellow, green, cyan, blue, violet)" data-color="rainbow"></div>
        </div>
      </div>
      <div class="control-group">
        <label>Fondo</label>
        <div style="display: flex;">
          <div class="bg-color-option" style="background-color: #000000" data-bgcolor="#000000"></div>
          <div class="bg-color-option" style="background-color: #ffffff" data-bgcolor="#ffffff"></div>
          <div class="bg-color-option" style="background-color: #222222" data-bgcolor="#222222"></div>
        </div>
      </div>
      <div class="control-group">
        <button id="toggleFloorBtn" class="active">Mostrar Suelo</button>
        <button id="exportBtn">Exportar GLB</button>
      </div>
      <button id="disableGodModeBtn">Desactivar Premium</button>
    </div>
  </div>

  <div class="axis-indicator" id="axisIndicator"></div>

  <script>
    // Variables globales
    let subdivision = 5, maxExtrusion = 100, minExtrusion = 0, randomness = 50;
    let boxSizePercent = 90, boxSize;
    let maxVertical = 0, minVertical = 0, verticalRandomness = 50;
    let extrusionValues = [], targetExtrusionValues = [];
    let verticalOffsets = [], targetVerticalOffsets = [];
    let isDragging = false, lastX, lastY;
    let rotX = -Math.PI/4, rotY = Math.PI/4;
    let targetRotX = rotX, targetRotY = rotY;
    let zoom = 1, targetZoom = 1, zoomEasing = 0.1, rotEasing = 0.1;
    let viewMode = 'solid', autoRotate = false, rotateSpeed = 3;
    let panX = 0, panY = 0, godMode = false;
    let modelColor = '#ffffff', rainbowMode = false, hue = 0;
    let bgColor = '#000000';
    let currentBoxSizePercent = 90;
    let sizeEasing = 0.08;
    let lastUpdateTime = 0;
    let showFloor = true;
    let isMetalWhite = false;
    let showSlab = true;
    let slabColor = '#228B22';
    let slabThicknessValues = [];
    let slabSizeValues = [];
    let increaseSlabSize = 1.0;
    let decreaseSlabSize = 1.0;
    let slabSizeRandomness = 0;
    let increaseSlabThickness = 5;
    let decreaseSlabThickness = 5;
    let slabThicknessRandomness = 0;
    let groundTexture, grassTexture;
    let transitionProgress = 0;
    let isTransitioning = false;
    let transitionStartTime = 0;
    let transitionDuration = 800;
    let oldSubdivision = 5;
    let transitionDirection = 0;
    let columnAppearTimes = [];
    let oldExtrusionValues = [];
    let oldVerticalOffsets = [];

    function preload() {
      // Precargar texturas con manejo de errores
      try {
        groundTexture = loadImage('ground.png');
        grassTexture = loadImage('grass.png');
      } catch (e) {
        console.error("Error loading textures:", e);
      }
    }

    function setup() {
      let canvas = createCanvas(windowWidth, windowHeight, WEBGL);
      canvas.elt.style.display = 'block'; // Asegurar que el canvas se muestre
      smooth();
      updateExtrusionValues(true);
      updateVerticalOffsets(true);
      updateSlabValues(true);
      initializeTransitionOrder();

      // Configuración inicial de controles
      document.getElementById('subdivisionValue').textContent = subdivision;
      document.getElementById('maxExtrusionValue').textContent = maxExtrusion;
      document.getElementById('minExtrusionValue').textContent = minExtrusion;
      document.getElementById('randomnessValue').textContent = randomness;
      document.getElementById('boxSizeValue').textContent = boxSizePercent + '%';

      // Configurar listeners
      setupEventListeners();
    }

    function setupEventListeners() {
      document.getElementById('subdivisionSlider').oninput = e => {
        subdivision = +e.target.value;
        document.getElementById('subdivisionValue').textContent = subdivision;
        updateExtrusionValues(true);
        updateVerticalOffsets(true);
        updateSlabValues(true);
      };

      document.getElementById('maxExtrusionSlider').oninput = e => {
        maxExtrusion = +e.target.value;
        document.getElementById('maxExtrusionValue').textContent = maxExtrusion;
        updateExtrusionValues();
      };

      // ... (otros listeners similares)

      document.getElementById('godModeBtn').onclick = () => {
        if (document.getElementById('godModeCode').value === '2565') {
          godMode = true;
          document.getElementById('godModePanel').style.display = 'block';
        }
      };

      document.getElementById('godPixelBtn').onclick = () => {
        viewMode = 'pixel';
        document.getElementById('godPixelBtn').classList.add('active');
        document.getElementById('godWireframeBtn').classList.remove('active');
        document.getElementById('godSolidBtn').classList.remove('active');
      };

      // ... (resto de listeners)
    }

    function draw() {
      let now = millis();
      if (now - lastUpdateTime < 16) return;
      lastUpdateTime = now;
      
      background(bgColor === '#000000' ? 0 : bgColor === '#ffffff' ? 255 : color(bgColor));
      
      // Configuración de luces
      ambientLight(40);
      directionalLight(200, 200, 200, 0, 1, 1);
      directionalLight(100, 100, 100, -1, -1, -1);

      // Actualizar parámetros de animación
      zoom = lerp(zoom, targetZoom, zoomEasing);
      rotX = lerp(rotX, targetRotX, rotEasing);
      rotY = lerp(rotY, targetRotY, rotEasing);
      currentBoxSizePercent = lerp(currentBoxSizePercent, boxSizePercent, sizeEasing);

      if (autoRotate) targetRotY += 0.005 * rotateSpeed;
      
      drawAxisIndicator();
      
      push();
      scale(zoom);
      translate(panX, panY);
      rotateX(rotX);
      rotateY(rotY);
      
      let baseSize = min(width, height) * 0.5 / subdivision;
      boxSize = baseSize * currentBoxSizePercent / 100;

      // Dibujar modelo 3D
      draw3DModel();
      
      pop();
    }

    function draw3DModel() {
      // Configurar estilo según el modo de vista
      if (viewMode === 'wireframe') { 
        noFill(); 
        stroke(modelColor); 
        strokeWeight(1); 
      } else if (viewMode === 'solid') { 
        if (isMetalWhite) {
          specularMaterial(255, 255, 255);
          shininess(50);
        } else {
          fill(modelColor); 
        }
        stroke(100); 
        strokeWeight(0.5); 
      } else if (viewMode === 'pixel') {
        stroke(100);
        strokeWeight(0.5);
      }

      // Dibujar suelo si está activado
      if (showFloor) {
        push();
        fill(50);
        noStroke();
        translate(0, 0, 0);
        rotateX(Math.PI/2);
        plane(subdivision * boxSize * 1.2, subdivision * boxSize * 1.2);
        pop();
      }

      // Dibujar columnas
      for (let x = 0; x < subdivision; x++) {
        for (let z = 0; z < subdivision; z++) {
          let idx = x * subdivision + z;
          if (idx >= extrusionValues.length) continue;
          
          let h = extrusionValues[idx];
          let offset = idx < verticalOffsets.length ? verticalOffsets[idx] : 0;
          let [posX, posZ] = getGridPosition(x, z, boxSize, subdivision);
          
          if (h > 0) {
            push();
            translate(posX, -(offset + h/2), posZ);
            
            if (viewMode === 'pixel' && groundTexture) {
              drawTexturedBox(boxSize * 0.95, h, boxSize * 0.95, groundTexture);
            } else {
              box(boxSize * 0.95, h, boxSize * 0.95);
            }
            pop();
            
            // Dibujar losa si está activado
            if (showSlab && godMode && idx < slabThicknessValues.length && idx < slabSizeValues.length) {
              let slabThickness = slabThicknessValues[idx];
              let slabSize = boxSize * slabSizeValues[idx];
              
              if (slabThickness > 0 && slabSize > 0) {
                push();
                translate(posX, -(offset + h + slabThickness/2), posZ);
                
                if (viewMode === 'pixel' && grassTexture) {
                  drawTexturedBox(slabSize, slabThickness, slabSize, grassTexture, slabColor);
                } else {
                  if (viewMode === 'wireframe') {
                    noFill();
                    stroke(slabColor);
                  } else {
                    fill(slabColor);
                  }
                  box(slabSize, slabThickness, slabSize);
                }
                pop();
              }
            }
          }
        }
      }
    }

    function drawTexturedBox(w, h, d, tex, faceColor = null) {
      texture(tex);
      textureWrap(REPEAT);
      let repeatX = w / 50;
      let repeatY = h / 50;
      
      // Caras laterales
      beginShape();
      vertex(-w/2, -h/2, -d/2, 0, 0);
      vertex(w/2, -h/2, -d/2, repeatX, 0);
      vertex(w/2, h/2, -d/2, repeatX, repeatY);
      vertex(-w/2, h/2, -d/2, 0, repeatY);
      endShape(CLOSE);
      
      // ... (caras restantes similares)

      // Caras superior e inferior
      if (faceColor) {
        fill(faceColor);
        box(w, 0.1, d);
        translate(0, -h/2, 0);
        box(w, 0.1, d);
      }
    }

    // ... (resto de funciones auxiliares)

    function windowResized() {
      resizeCanvas(windowWidth, windowHeight);
    }
  </script>
</body>
</html>
